- name: Apply migrations to Turso
  env:
    TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
    TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
  run: |
    # Get the latest migration
    LATEST_MIGRATION=$(ls -t prisma/migrations/*/migration.sql | head -1)

    # Apply using curl and Turso HTTP API
    curl -X POST \
      "${TURSO_DATABASE_URL}/v2/pipeline" \
      -H "Authorization: Bearer ${TURSO_AUTH_TOKEN}" \
      -H "Content-Type: application/json" \
      -d "{\"requests\": [{\"type\": \"execute\", \"stmt\": {\"sql\": \"$(cat $LATEST_MIGRATION | jq -Rs .)\"}}]}"
