name: Deploy Database Migrations

on:
  push:
    branches:
      - main

  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Apply migrations to Turso via HTTP API
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
        run: |
          # Convert libsql:// URL to https:// for HTTP API
          HTTP_URL=$(echo $TURSO_DATABASE_URL | sed 's|libsql://|https://|')

          echo "Applying migrations to Turso database..."

          # Find and apply all migration files in order
          for migration_dir in $(ls -d prisma/migrations/*/ | sort); do
            if [ -f "${migration_dir}migration.sql" ]; then
              MIGRATION_NAME=$(basename $migration_dir)
              echo "Applying migration: $MIGRATION_NAME"
              
              # Read the SQL file
              SQL_CONTENT=$(cat "${migration_dir}migration.sql")
              
              # Execute via Turso HTTP API
              RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
                "${HTTP_URL}/v2/pipeline" \
                -H "Authorization: Bearer ${TURSO_AUTH_TOKEN}" \
                -H "Content-Type: application/json" \
                -d "{\"requests\": [{\"type\": \"execute\", \"stmt\": {\"sql\": $(echo "$SQL_CONTENT" | jq -Rs .)}}]}")
              
              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              BODY=$(echo "$RESPONSE" | sed '$d')
              
              if [ "$HTTP_CODE" -eq 200 ]; then
                echo "✓ Migration $MIGRATION_NAME applied successfully"
              else
                echo "✗ Migration $MIGRATION_NAME failed with HTTP $HTTP_CODE"
                echo "Response: $BODY"
                exit 1
              fi
            fi
          done

          echo "All migrations applied successfully!"
